<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GlobalGlide360 - Itinerari AI (Debug)</title>
  <style>
    body{font-family:Arial,sans-serif;color:#222;background:#fff;}
    header, footer{background:#0077b6;color:white;text-align:center;padding:10px;}
    .container{max-width:800px;margin:20px auto;padding:10px;}
    form{display:grid;gap:10px;}
    input,button{padding:12px;border-radius:6px;border:1px solid #ccc;font-size:16px;}
    button{background:#0077b6;color:white;border:none;cursor:pointer;}
    #results{margin-top:20px;}
    .card{background:#f8f8f8;padding:10px;border-radius:6px;margin-bottom:10px;}
  </style>
</head>
<body>
  <header><h1>GlobalGlide360 (Debug)</h1></header>
  <div class="container">
    <h2>Test ricerca itinerario</h2>
    <form id="travel-form">
      <input type="text" name="destinazione" placeholder="Destinazione (es. Roma)" required>
      <input type="date" name="data-partenza" required>
      <input type="number" name="persone" placeholder="Numero persone" min="1" value="1" required>
      <input type="number" name="budget" placeholder="Budget €/persona" min="50" step="50" required>
      <button type="submit">Cerca</button>
    </form>
    <div id="results"></div>
  </div>
  <footer><p>Debug mode</p></footer>

<script>
const form = document.getElementById("travel-form");
const results = document.getElementById("results");

const cityData = {
  "roma": { iata: "ROM", lat: 41.9028, lon: 12.4964 },
  "parigi": { iata: "PAR", lat: 48.8566, lon: 2.3522 },
  "milano": { iata: "MIL", lat: 45.4642, lon: 9.19 },
  "lisbona": { iata: "LIS", lat: 38.7169, lon: -9.139 },
  "londra": { iata: "LON", lat: 51.5074, lon: -0.1278 }
};

const clientId = "kDR8582BVq2qikHZUQAaUBLlZNzTVp50";
const clientSecret = "6e8Wjj1R9axfFAIx";
let token = null;

async function getToken() {
  console.log("🔑 Generazione token...");
  const res = await fetch("https://test.api.amadeus.com/v1/security/oauth2/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `grant_type=client_credentials&client_id=${clientId}&client_secret=${clientSecret}`
  });
  const data = await res.json();
  console.log("🔑 Token risposta:", data);
  return data.access_token;
}

form.addEventListener("submit", async e => {
  e.preventDefault();
  results.innerHTML = "⏳ Ricerca in corso...";

  let destinazione = form.elements["destinazione"].value.trim().toLowerCase();
  const dataPartenza = form.elements["data-partenza"].value;
  const persone = form.elements["persone"].value;
  const budget = form.elements["budget"].value;

  const cityInfo = cityData[destinazione];
  if (!cityInfo) {
    results.innerHTML = "⚠️ Destinazione non trovata. Inserisci Roma, Milano, Parigi, Londra o Lisbona per il test.";
    return;
  }

  try {
    if (!token) token = await getToken();

    // VOLI
    console.log("✈️ Chiamata voli...");
    const voliRes = await fetch(`https://test.api.amadeus.com/v2/shopping/flight-offers?originLocationCode=MIL&destinationLocationCode=${cityInfo.iata}&departureDate=${dataPartenza}&adults=${persone}&currencyCode=EUR`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const dataVoli = await voliRes.json();
    console.log("✈️ Risposta voli:", dataVoli);

    // HOTEL
    console.log("🏨 Chiamata hotel...");
    const hotelRes = await fetch(`https://test.api.amadeus.com/v2/shopping/hotel-offers?cityCode=${cityInfo.iata}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const dataHotel = await hotelRes.json();
    console.log("🏨 Risposta hotel:", dataHotel);

    // ATTIVITÀ
    console.log("🎟️ Chiamata attività...");
    const attivitaRes = await fetch(`https://test.api.amadeus.com/v1/shopping/activities?latitude=${cityInfo.lat}&longitude=${cityInfo.lon}&radius=10`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const dataAttivita = await attivitaRes.json();
    console.log("🎟️ Risposta attività:", dataAttivita);

    // MOSTRA RISULTATI
    results.innerHTML = `<h3>Risultati per ${destinazione}</h3>`;

    if (dataVoli.data && dataVoli.data.length > 0) {
      results.innerHTML += `<div class="card">✈️ Volo: ${dataVoli.data[0].price.total}€</div>`;
    } else {
      results.innerHTML += `<div class="card">✈️ Nessun volo trovato</div>`;
    }

    if (dataHotel.data && dataHotel.data.length > 0) {
      results.innerHTML += `<div class="card">🏨 Hotel: ${dataHotel.data[0].hotel.name}</div>`;
    } else {
      results.innerHTML += `<div class="card">🏨 Nessun hotel trovato</div>`;
    }

    if (dataAttivita.data && dataAttivita.data.length > 0) {
      results.innerHTML += `<div class="card">🎟️ Attività: ${dataAttivita.data[0].name}</div>`;
    } else {
      results.innerHTML += `<div class="card">🎟️ Nessuna attività trovata</div>`;
    }

  } catch (error) {
    console.error("❌ Errore generale:", error);
    results.innerHTML = "❌ Errore durante la ricerca (vedi console F12).";
  }
});
</script>
</body>
</html>
